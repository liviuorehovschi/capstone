{% extends "base.html" %}

{% block title %}Diagnostic Tool - Lung Cancer Detection System{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/diagnostic.css') }}">
{% endblock %}

{% block content %}
<div class="diagnostic-container">
    <h1>Lung Tissue Analysis Tool</h1>
    <p>Upload a histopathological image of lung tissue to detect if it is normal or shows signs of cancer.</p>
    
    <form id="uploadForm" enctype="multipart/form-data">
        <div class="upload-box">
            <input type="file" name="file" accept="image/*" id="fileInput" required>
            <label for="fileInput">Select histopathological image</label>
        </div>

        <!-- Image preview area -->
        <div id="imagePreview" class="preview-wrapper" style="display: none;">
            <div class="preview-trio">
                <img id="saliencyPreview" class="side-preview" alt="Saliency Map" style="display: none;">
                <img id="preview" class="center-preview" alt="Original Image">
                <img id="gradcamPreview" class="side-preview" alt="Grad-CAM" style="display: none;">
            </div>
        </div>

        <button type="submit" class="button">Analyze</button>
    </form>

    <div id="loadingContainer" class="loading-container">
        <h3>Analyzing tissue sample...</h3>
        <div class="scanner"></div>
        <p>Processing image using advanced AI analysis</p>
    </div>

    <!-- Result box -->
    <div id="result" class="result-box" style="display: none;"></div>

    <!-- Map buttons shown after prediction -->
    <div class="button-row" id="mapButtonRow" style="display: none;">
        <button type="button" id="showSaliencyBtn" class="small-button">Show Saliency Map</button>
        <button type="button" id="showGradcamBtn" class="small-button">Show Grad-CAM</button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/diagnostic.js') }}"></script>
<script>
    const uploadForm = document.getElementById('uploadForm');
    const resultBox = document.getElementById('result');
    const loadingContainer = document.getElementById('loadingContainer');

    uploadForm.addEventListener('submit', function(e) {
        e.preventDefault();

        const fileInput = document.getElementById('fileInput');
        if (!fileInput.files.length) {
            resultBox.textContent = "Please select an image.";
            return;
        }

        const formData = new FormData();
        formData.append('file', fileInput.files[0]);

        loadingContainer.style.display = 'block';
        resultBox.style.display = 'none';
        resultBox.textContent = '';

        fetch('/predict', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                return response.text().then(text => {
                    throw new Error(text);
                });
            }
            return response.json();
        })
        .then(data => {
            loadingContainer.style.display = 'none';
            resultBox.style.display = 'block';

            if (data.error) {
                resultBox.innerHTML = `<p>Error: ${data.error}</p>`;
            } else {
                resultBox.innerHTML = `
                    <h3>Diagnosis Result</h3>
                    <p><strong>Prediction:</strong> ${data.class}</p>
                    <p>
                        <strong>Confidence:</strong> ${(data.confidence * 100).toFixed(2)}%
                        <span class="info-icon" title="Confidence represents how certain the AI is in its prediction.">â“˜</span>
                    </p>
                `;
                document.getElementById('mapButtonRow').style.display = 'flex';
                setupMapButtons(fileInput.files[0]);
            }
        })
        .catch(err => {
            loadingContainer.style.display = 'none';
            resultBox.style.display = 'block';
            resultBox.textContent = "An error occurred: " + err.message;
        });
    });

    function setupMapButtons(file) {
        const saliencyPreview = document.getElementById('saliencyPreview');
        const gradcamPreview = document.getElementById('gradcamPreview');

        document.getElementById('showSaliencyBtn').addEventListener('click', () => {
            const saliencyForm = new FormData();
            saliencyForm.append('file', file);
            fetch('/saliency_image', { method: 'POST', body: saliencyForm })
                .then(res => res.blob())
                .then(blob => {
                    saliencyPreview.src = URL.createObjectURL(blob);
                    saliencyPreview.style.display = 'block';
                });
        });

        document.getElementById('showGradcamBtn').addEventListener('click', () => {
            const gradcamForm = new FormData();
            gradcamForm.append('file', file);
            fetch('/gradcam_image', { method: 'POST', body: gradcamForm })
                .then(res => res.blob())
                .then(blob => {
                    gradcamPreview.src = URL.createObjectURL(blob);
                    gradcamPreview.style.display = 'block';
                });
        });
    }

    document.getElementById('fileInput').addEventListener('change', function(e) {
        const preview = document.getElementById('preview');
        const previewContainer = document.getElementById('imagePreview');
        const saliencyPreview = document.getElementById('saliencyPreview');
        const gradcamPreview = document.getElementById('gradcamPreview');
        const mapButtonRow = document.getElementById('mapButtonRow');
        
        if (e.target.files && e.target.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                preview.src = e.target.result;
                previewContainer.style.display = 'block';
                saliencyPreview.style.display = 'none';
                gradcamPreview.style.display = 'none';
                saliencyPreview.src = '';
                gradcamPreview.src = '';
                mapButtonRow.style.display = 'none';
            };
            reader.readAsDataURL(e.target.files[0]);
        }
    });
</script>
{% endblock %}
